Change locks in test process to be async to avoid deadlocks