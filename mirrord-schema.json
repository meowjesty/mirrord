{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "LayerFileConfig",
  "description": "Main struct for mirrord-layer's configuration\n\n## Examples\n\n- Run mirrord with read-only file operations, mirroring traffic, skipping unwanted processes:\n\n```toml # mirrord-config.toml\n\ntarget = \"pod/sample-pod-1234\" skip_processes = [\"ide-debugger\", \"ide-service\"] # we don't want mirrord to hook into these\n\n[agent] log_level = \"debug\" ttl = 1024 # seconds\n\n[fs] mode = \"read\"\n\n[network] incoming = \"mirror\" ```\n\n- Run mirrord with read-write file operations, stealing traffic, accept local TLS certificates, use a custom mirrord-agent image:\n\n```toml # mirrord-config.toml\n\ntarget = \"pod/sample-pod-1234\" accept_invalid_certificates = true\n\n[agent] log_level = \"debug\" ttl = 1024 # seconds image = \"registry/mirrord-agent-custom:latest\" image_pull_policy = \"Always\"\n\n[fs] mode = \"write\"\n\n[network] incoming = \"steal\" ```",
  "type": "object",
  "properties": {
    "accept_invalid_certificates": {
      "description": "Controls whether or not mirrord accepts invalid TLS certificates (e.g. self-signed certificates).",
      "type": [
        "boolean",
        "null"
      ]
    },
    "agent": {
      "description": "Agent configuration, see [`agent::AgentFileConfig`].",
      "allOf": [
        {
          "$ref": "#/definitions/AgentFileConfig"
        }
      ]
    },
    "connect_agent_name": {
      "description": "Agent name that already exists that we can connect to.",
      "type": [
        "string",
        "null"
      ]
    },
    "connect_agent_port": {
      "description": "Agent listen port that already exists that we can connect to.",
      "type": [
        "integer",
        "null"
      ],
      "format": "uint16",
      "minimum": 0.0
    },
    "connect_tcp": {
      "description": "IP:PORT to connect to instead of using k8s api, for testing purposes.",
      "type": [
        "string",
        "null"
      ]
    },
    "feature": {
      "description": "Controls mirrord features, see [`feature::FeatureFileConfig`].",
      "allOf": [
        {
          "$ref": "#/definitions/FeatureFileConfig"
        }
      ]
    },
    "skip_processes": {
      "description": "Allows mirrord to skip unwanted processes.\n\nUseful when process A spawns process B, and the user wants mirrord to operate only on process B.",
      "anyOf": [
        {
          "$ref": "#/definitions/VecOrSingle_for_String"
        },
        {
          "type": "null"
        }
      ]
    },
    "target": {
      "description": "Specifies the running pod to mirror.\n\nSupports: - `pod/{sample-pod}`; - `podname/{sample-pod}`; - `deployment/{sample-deployment}`; - `container/{sample-container}`; - `containername/{sample-container}`.",
      "allOf": [
        {
          "$ref": "#/definitions/TargetFileConfig"
        }
      ]
    }
  },
  "additionalProperties": false,
  "definitions": {
    "AdvancedFsUserConfig": {
      "description": "Advanced user configuration for file operations.\n\nAllows the user to specify:\n\n- `MIRRORD_FILE_OPS` and `MIRRORD_FILE_RO_OPS`; - `MIRRORD_FILE_FILTER_INCLUDE` and `MIRRORD_FILE_FILTER_EXCLUDE`;\n\n## Examples\n\n- Read-only excluding `.foo` files:\n\n```yaml # mirrord-config.yaml\n\n[fs] mode = read exclude = \"^.*\\.foo$\" ```\n\n- Read-write including only `.baz` files:\n\n```yaml # mirrord-config.yaml\n\n[fs] mode = write include = \"^.*\\.baz$\" ```",
      "type": "object",
      "properties": {
        "exclude": {
          "description": "Allows the user to specify regexes that are used to match against files when mirrord file operations are enabled.\n\nThe opposite of `include`, files that match the regexes specified here will bypass mirrord and are accessed locally.",
          "anyOf": [
            {
              "$ref": "#/definitions/VecOrSingle_for_String"
            },
            {
              "type": "null"
            }
          ]
        },
        "include": {
          "description": "Allows the user to specify regexes that are used to match against files when mirrord file operations are enabled.\n\nThe regexes specified here will make mirrord operate only on files that match it, otherwise the file will be accessed locally (bypassing mirrord).",
          "anyOf": [
            {
              "$ref": "#/definitions/VecOrSingle_for_String"
            },
            {
              "type": "null"
            }
          ]
        },
        "mode": {
          "description": "File operations mode, defaults to read-only, see [`FsModeConfig`].",
          "allOf": [
            {
              "$ref": "#/definitions/FsModeConfig"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "AgentFileConfig": {
      "description": "Configuration for the mirrord-agent pod that is spawned in the Kubernetes cluster.",
      "type": "object",
      "properties": {
        "communication_timeout": {
          "description": "Controls how long the agent lives when there are no connections.\n\nEach connection has its own heartbeat mechanism, so even if the local application has no messages, the agent stays alive until there are no more heartbeat messages.",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint16",
          "minimum": 0.0
        },
        "ephemeral": {
          "description": "Runs the agent as an [ephemeral container](https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/)",
          "type": [
            "boolean",
            "null"
          ]
        },
        "image": {
          "description": "Name of the agent's docker image.\n\nUseful when a custom build of mirrord-agent is required, or when using an internal registry.\n\nDefaults to the latest stable image.",
          "type": [
            "string",
            "null"
          ]
        },
        "image_pull_policy": {
          "description": "Controls when a new agent image is downloaded.\n\nSupports any valid kubernetes [image pull policy](https://kubernetes.io/docs/concepts/containers/images/#image-pull-policy)",
          "type": [
            "string",
            "null"
          ]
        },
        "log_level": {
          "description": "Log level for the agent.\n\nSupports anything that would work with `RUST_LOG`.",
          "type": [
            "string",
            "null"
          ]
        },
        "namespace": {
          "description": "Namespace where the agent shall live.\n\nDefaults to the current kubernetes namespace.",
          "type": [
            "string",
            "null"
          ]
        },
        "startup_timeout": {
          "description": "Controls how long to wait for the agent to finish initialization.\n\nIf initialization takes longer than this value, mirrord exits.",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint64",
          "minimum": 0.0
        },
        "ttl": {
          "description": "Controls how long the agent pod persists for, after the local process terminated (in seconds).\n\nCan be useful for collecting logs.",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint16",
          "minimum": 0.0
        }
      },
      "additionalProperties": false
    },
    "DeploymentTarget": {
      "type": "object",
      "required": [
        "deployment"
      ],
      "properties": {
        "container": {
          "type": [
            "string",
            "null"
          ]
        },
        "deployment": {
          "type": "string"
        }
      }
    },
    "EnvFileConfig": {
      "description": "Allows the user to set or override a local process' environment variables with the ones from a remote pod.\n\nWhich environment variables to load from the remote pod are controlled by setting either `include` or `exclude`.\n\n## Examples\n\n- Include every environment variable from the remote pod (default):\n\n```yaml # mirrord-config.yaml\n\ninclude = \"*\" ```\n\nSome environment variables are excluded by default (`PATH` for example), including these requires specifying them with `include`, see [`mirrord_agent::env::EnvFilter`].\n\n- Include the remote pod's environment variables \"PROJECT\", \"DATABASE\":\n\n```yaml # mirrord-config.yaml\n\ninclude = \"PROJECT;DATABASE\" ```\n\n- Exclude the remote pod's environment variables \"PROJECT\", \"DATABASE\", and include everything else:\n\n```yaml # mirrord-config.yaml\n\nexclude = \"PROJECT;DATABASE\" ```",
      "type": "object",
      "properties": {
        "exclude": {
          "description": "Include the remote environment variables in the local process that are **NOT** specified by this option.\n\nValue is a list separated by \";\".",
          "anyOf": [
            {
              "$ref": "#/definitions/VecOrSingle_for_String"
            },
            {
              "type": "null"
            }
          ]
        },
        "include": {
          "description": "Include only these remote environment variables in the local process.\n\nValue is a list separated by \";\".",
          "anyOf": [
            {
              "$ref": "#/definitions/VecOrSingle_for_String"
            },
            {
              "type": "null"
            }
          ]
        },
        "override": {
          "description": "Allows setting or overriding environment variables (locally) with a custom value.\n\nFor example, if the remote pod has an environment variable `REGION=1`, but this is an undesirable value, it's possible to use `overrides` to set `REGION=2` (locally) instead.",
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": {
            "type": "string"
          }
        }
      },
      "additionalProperties": false
    },
    "FeatureFileConfig": {
      "description": "Configuration for mirrord features.",
      "type": "object",
      "properties": {
        "env": {
          "description": "Controls the environment variables feature, see [`EnvFileConfig`].",
          "allOf": [
            {
              "$ref": "#/definitions/ToggleableConfig_for_EnvFileConfig"
            }
          ]
        },
        "fs": {
          "description": "Controls the file operations feature, see [`FsUserConfig`].",
          "allOf": [
            {
              "$ref": "#/definitions/ToggleableConfig_for_FsUserConfig"
            }
          ]
        },
        "network": {
          "description": "Controls the network feature, see [`NetworkFileConfig`].",
          "allOf": [
            {
              "$ref": "#/definitions/ToggleableConfig_for_NetworkFileConfig"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "FsModeConfig": {
      "description": "Configuration for enabling read-only and read-write file operations.\n\nDefault option for general file configuration. Allows the user to specify:\n\n- `MIRRORD_FILE_OPS` and `MIRRORD_FILE_RO_OPS`;\n\n## Examples\n\n- Disable mirrord file operations:\n\n```yaml # mirrord-config.yaml\n\nfs = disabled ```\n\n- Enable mirrord read-write file operations:\n\n```yaml # mirrord-config.yaml\n\nfs = write ```",
      "type": "string",
      "enum": [
        "disabled",
        "read",
        "write"
      ]
    },
    "FsUserConfig": {
      "description": "Changes file operations behavior based on user configuration.\n\nDefaults to [`FsUserConfig::Simple`], with [`FsModeConfig::Read`].\n\n## Examples\n\n- Read-write file operations:\n\n```toml # mirrord-config.toml\n\nfs = write ```\n\n- Read-only excluding `.foo` files:\n\n```toml # mirrord-config.toml\n\n[fs] mode = read exclude = \"^.*\\.foo$\" ```\n\n- Read-write including only `.baz` files:\n\n```toml # mirrord-config.toml\n\n[fs] mode = write include = \"^.*\\.baz$\" ```",
      "anyOf": [
        {
          "description": "Basic configuration that controls the env vars `MIRRORD_FILE_OPS` and `MIRRORD_FILE_RO_OPS` (default).",
          "allOf": [
            {
              "$ref": "#/definitions/FsModeConfig"
            }
          ]
        },
        {
          "description": "Allows the user to specify both [`FsModeConfig`] (as above), and configuration for the `MIRRORD_FILE_FILTER_INCLUDE` and `MIRRORD_FILE_FILTER_EXCLUDE` env vars.",
          "allOf": [
            {
              "$ref": "#/definitions/AdvancedFsUserConfig"
            }
          ]
        }
      ]
    },
    "IncomingConfig": {
      "type": "string",
      "enum": [
        "mirror",
        "steal"
      ]
    },
    "NetworkFileConfig": {
      "description": "Controls mirrord network operations.",
      "type": "object",
      "properties": {
        "dns": {
          "description": "Resolve DNS via the remote pod.",
          "type": [
            "boolean",
            "null"
          ]
        },
        "incoming": {
          "description": "Mode of operation for incoming network requests in mirrord, supports `mirror` or `steal`:\n\n- `mirror`: mirror incoming requests to the remote pod to the local process; ` `steal`: redirect incoming requests to the remote pod to the local process",
          "anyOf": [
            {
              "$ref": "#/definitions/IncomingConfig"
            },
            {
              "type": "null"
            }
          ]
        },
        "outgoing": {
          "description": "Tunnel outgoing network operations through mirrord.",
          "allOf": [
            {
              "$ref": "#/definitions/ToggleableConfig_for_OutgoingFileConfig"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "OutgoingFileConfig": {
      "type": "object",
      "properties": {
        "tcp": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "udp": {
          "type": [
            "boolean",
            "null"
          ]
        }
      },
      "additionalProperties": false
    },
    "PodTarget": {
      "type": "object",
      "required": [
        "pod"
      ],
      "properties": {
        "container": {
          "type": [
            "string",
            "null"
          ]
        },
        "pod": {
          "type": "string"
        }
      }
    },
    "Target": {
      "anyOf": [
        {
          "$ref": "#/definitions/DeploymentTarget"
        },
        {
          "$ref": "#/definitions/PodTarget"
        }
      ]
    },
    "TargetFileConfig": {
      "anyOf": [
        {
          "anyOf": [
            {
              "$ref": "#/definitions/Target"
            },
            {
              "type": "null"
            }
          ]
        },
        {
          "type": "object",
          "properties": {
            "namespace": {
              "type": [
                "string",
                "null"
              ]
            },
            "path": {
              "anyOf": [
                {
                  "$ref": "#/definitions/Target"
                },
                {
                  "type": "null"
                }
              ]
            }
          }
        }
      ]
    },
    "ToggleableConfig_for_EnvFileConfig": {
      "anyOf": [
        {
          "type": "boolean"
        },
        {
          "$ref": "#/definitions/EnvFileConfig"
        }
      ]
    },
    "ToggleableConfig_for_FsUserConfig": {
      "anyOf": [
        {
          "type": "boolean"
        },
        {
          "$ref": "#/definitions/FsUserConfig"
        }
      ]
    },
    "ToggleableConfig_for_NetworkFileConfig": {
      "anyOf": [
        {
          "type": "boolean"
        },
        {
          "$ref": "#/definitions/NetworkFileConfig"
        }
      ]
    },
    "ToggleableConfig_for_OutgoingFileConfig": {
      "anyOf": [
        {
          "type": "boolean"
        },
        {
          "$ref": "#/definitions/OutgoingFileConfig"
        }
      ]
    },
    "VecOrSingle_for_String": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      ]
    }
  }
}